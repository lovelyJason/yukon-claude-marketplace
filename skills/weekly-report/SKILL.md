---
name: weekly-report
description: 根据本周 Git 提交记录自动生成周报，支持多种预设格式。触发场景：(1) 用户说"帮我写周报"、"生成周报"、"本周工作总结" (2) 用户运行 /weekly-report (3) 用户问"这周做了什么"
---

# Weekly Report - 周报生成器

根据本周的 Git 提交记录，结合用户补充信息，自动生成格式化周报。

## 执行流程

### Step 0: 一次性收集基本信息

**重要**：使用 AskUserQuestion 工具**一次性**询问以下所有问题（该工具支持同时提问 1-4 个问题），避免多次打断用户：

```
AskUserQuestion({
  questions: [
    {
      question: "本次周报的统计周期是？（例如：本周、上周、1/27到1/31、上周五到本周四）",
      header: "统计周期",
      options: [
        { label: "本周", description: "从本周一到今天" },
        { label: "上周", description: "上周一到上周日" },
        { label: "最近7天", description: "从今天往前推7天" }
      ],
      multiSelect: false
    },
    {
      question: "请提供需要统计的 Git 项目路径：",
      header: "项目路径",
      options: [
        { label: "当前目录", description: "只统计当前项目" },
        { label: "指定目录下所有项目", description: "扫描某个目录下的所有 Git 仓库" },
        { label: "多个项目", description: "我会在 Other 中输入多个项目路径" }
      ],
      multiSelect: false
    },
    {
      question: "选择周报格式：",
      header: "周报格式",
      options: [
        { label: "A 表格式（推荐）", description: "按日期范围+项目+任务+内容+备注+进度的表格" },
        { label: "B 分类式", description: "按需求开发/Bug修复/技术优化分类展示" },
        { label: "C 简洁式", description: "纯列表，本周工作+下周计划+风险" },
        { label: "D OKR式", description: "关联目标和关键结果" }
      ],
      multiSelect: false
    }
  ]
})
```

#### 统计周期解析规则

用户可以用自然语言描述，需要解析为具体的起止日期：

- "上周五到本周四" → 计算上周五和本周四的具体日期
- "1/27 到 1/31" → 直接使用
- "本周" → 本周一到今天
- "上周" → 上周一到上周日
- "最近7天" → 今天往前推7天 → 今天
- 如果用户只说了一个日期，询问确认另一个日期

#### 项目路径处理逻辑

根据用户的选择：

- **当前目录**：直接使用当前工作目录
- **指定目录下所有项目**：用户在 Other 中输入一个父目录路径（如 `/Users/xxx/projects`），然后自动扫描该目录下所有包含 `.git` 的子目录：
  ```bash
  # 扫描指定目录下的所有 Git 仓库（只扫一层）
  find {parentDir} -maxdepth 2 -name ".git" -type d | xargs -I {} dirname {}
  ```
  将扫描结果列出，让用户确认哪些仓库需要纳入统计
- **多个项目**：用户在 Other 中输入多个路径（每行一个）
- 对每个路径验证是否为有效的 Git 仓库（检查 `.git` 目录是否存在）
- 如果路径无效，提示用户并跳过该路径
- 自动从每个仓库的目录名或 `package.json` 的 `name` 字段提取项目名称

### Step 1: 周报格式详情

用户在 Step 0 中已选择了周报格式，以下是各预设的详细模板：

**预设格式列表**：

#### 预设 A：表格式周报（推荐）

适合：需要按项目/任务维度汇报的团队

```markdown
## 本周完成工作

| 日期范围 | 项目 | 任务 | 工作内容 | 备注 | 当前进度 |
|---------|------|------|---------|------|---------|
| 1/6-1/7 | 商城后台 | 用户模块重构 | 重构用户列表页，优化查询性能 | 已上线 | 100% |
| 1/8-1/9 | 商城后台 | 订单导出功能 | 新增批量导出 Excel | 待测试 | 80% |
| 1/10 | 内部工具 | CI 流程优化 | 添加自动化测试步骤 | | 100% |

## 下周工作计划

| 优先级 | 项目 | 任务 | 预计时间 |
|-------|------|------|---------|
| P0 | 商城后台 | 订单导出功能测试上线 | 1天 |
| P1 | 商城后台 | 支付对账模块开发 | 3天 |
| P2 | 内部工具 | 部署文档更新 | 0.5天 |
```

#### 预设 B：分类式周报

适合：按工作类型汇报的团队

```markdown
## 本周完成工作

### 需求开发
- 【商城后台】完成用户模块重构，优化查询性能（已上线）
- 【商城后台】新增订单批量导出 Excel 功能（待测试，进度 80%）

### Bug 修复
- 【商城前台】修复商品详情页在 iOS 下的布局错位问题
- 【商城后台】修复分页参数计算错误

### 技术优化
- 优化 CI 流程，添加自动化测试步骤
- 升级项目依赖，修复安全漏洞

### 其他
- 参与新人 code review
- 需求评审：支付对账模块

## 下周工作计划
1. **[P0]** 订单导出功能测试上线
2. **[P1]** 支付对账模块开发
3. **[P2]** 部署文档更新
```

#### 预设 C：简洁式周报

适合：小团队、扁平化管理

```markdown
## 本周工作
1. 完成用户模块重构并上线
2. 开发订单批量导出功能（进度 80%）
3. 修复 2 个线上 Bug
4. 优化 CI 流程

## 下周计划
1. 订单导出上线
2. 启动支付对账模块
3. 更新部署文档

## 风险/阻塞
- 支付对账接口文档未确认，可能影响排期
```

#### 预设 D：OKR 关联式周报

适合：使用 OKR 管理的团队

```markdown
## 本周进展

### O1: 提升商城系统稳定性
- **KR1: 核心页面性能优化**
  - 完成用户列表页重构，查询耗时从 3s → 500ms ✅
  - 进度：60% → 75%
- **KR2: 线上 Bug 清零**
  - 本周修复 2 个 P1 Bug，剩余 3 个
  - 进度：40% → 55%

### O2: 提升团队工程效率
- **KR1: CI/CD 流程完善**
  - 添加自动化测试步骤，覆盖率从 45% → 60%
  - 进度：50% → 70%

## 下周重点
1. **[P0]** 继续推进 KR1 - 订单模块性能优化
2. **[P1]** KR2 - 处理剩余 3 个线上 Bug
```

#### 预设 E：自定义格式

用户自己描述想要的周报格式，按用户要求生成。

---

### Step 2: 收集 Git 提交数据

根据 Step 0 中用户提供的**统计周期**和**项目路径**，收集各仓库的提交记录。

**每个仓库需要执行的命令**：

```bash
# {startDate} 和 {endDate} 来自用户指定的统计周期
# {repoPath} 来自用户提供的项目路径列表

# 获取提交记录
git -C {repoPath} log --since="{startDate}" --until="{endDate} 23:59:59" --pretty=format:"%h|%ad|%s" --date=format:"%Y-%m-%d %H:%M" --author="$(git -C {repoPath} config user.name)" --no-merges

# 获取涉及的文件变更统计
git -C {repoPath} log --since="{startDate}" --until="{endDate} 23:59:59" --author="$(git -C {repoPath} config user.name)" --no-merges --stat

# 获取每天的提交数量
git -C {repoPath} log --since="{startDate}" --until="{endDate} 23:59:59" --author="$(git -C {repoPath} config user.name)" --no-merges --format="%ad" --date=format:"%Y-%m-%d" | sort | uniq -c
```

**执行策略 - 所有仓库一律并行**：

**关键**：不管有多少个仓库，都必须在**同一条消息**中发出所有 Bash 工具调用，让它们并行执行。绝对不能一个一个串行跑！

每个仓库的 3 条 git 命令合并为 1 条（用 `&&` 连接），然后所有仓库的 Bash 调用在同一条消息中并行发出：

```
# 关键：在同一条消息中并行发出所有 Bash 调用（不是一个一个发！）
# 每个 Bash 调用负责一个仓库，同时发出 = 并行执行

Bash(description="收集 repo-a 提交记录"): git -C /path/to/repo-a config user.name && git -C /path/to/repo-a log --since="..." --until="..." --pretty=format:"%h|%ad|%s" --date=format:"%Y-%m-%d" --author="$(git -C /path/to/repo-a config user.name)" --no-merges && echo "---STAT---" && git -C /path/to/repo-a log --since="..." --until="..." --author="$(git -C /path/to/repo-a config user.name)" --no-merges --stat

Bash(description="收集 repo-b 提交记录"): git -C /path/to/repo-b config user.name && git -C /path/to/repo-b log ...（同上）

Bash(description="收集 repo-c 提交记录"): git -C /path/to/repo-c config user.name && git -C /path/to/repo-c log ...（同上）

# ...对所有仓库都在这一条消息里发出
```

**注意**：如果某个仓库在统计周期内没有提交，git log 会返回空输出，这是正常的，跳过即可。

**多仓库合并规则**：
- 每个仓库的提交记录独立收集
- 用仓库目录名或 package.json 的 name 字段作为项目名
- 合并后按项目分组、按日期排序
- 如果某个仓库在统计周期内没有提交，标注"无提交记录"并跳过

### Step 3: 分析提交内容

对收集到的 commit 进行分类：

1. **按项目分组**：根据仓库名或 scope 分组
2. **按类型分类**：
   - `feat` → 需求开发
   - `fix` → Bug 修复
   - `refactor`/`perf` → 技术优化
   - `docs` → 文档
   - `test` → 测试
   - `chore`/`build`/`ci` → 工程化/其他
3. **提取关键信息**：任务名、工作内容、影响范围

### Step 4: 补充信息

使用 AskUserQuestion 工具向用户询问：

#### 4.1 确认和补充本周工作

```
我从 Git 记录中分析到以下工作内容，请确认并补充：

[自动生成的工作列表]

请补充：
1. 是否有 Git 未记录的工作？（如会议、评审、调研等）
2. 各项任务的当前进度？（如 80%、已上线等）
3. 是否有需要特别说明的备注？
```

#### 4.2 下周计划

```
请提供下周工作计划（可以简单列几条，我会帮你格式化）：

示例：
- 订单导出上线 P0
- 开始做支付对账 P1
- 更新文档 P2
```

#### 4.3 风险/阻塞（可选）

```
本周是否有遇到风险或阻塞项？（没有可跳过）

示例：
- 某接口文档未确认
- 某依赖有安全漏洞待处理
```

### Step 5: 生成周报

根据选择的预设格式 + Git 数据 + 用户补充信息，生成完整周报。

**输出要求**：
1. 直接输出 Markdown 格式的周报内容
2. 日期范围使用用户在 Step 0.1 中指定的统计周期
3. 项目名从各仓库目录名或 package.json 获取
4. 多仓库的提交按项目分组展示
5. 下周计划按优先级排序（P0 > P1 > P2 > P3）

### Step 6: 确认修改

将生成的周报展示给用户，询问是否需要修改：

```
以上是生成的周报，你可以：
1. 直接使用 ✅
2. 告诉我需要修改的地方
3. 复制到你的周报系统中
```

## 日期计算规则

统计周期由用户在 Step 0.1 中指定，以下是自然语言解析规则：

| 用户输入 | 解析结果 |
|---------|---------|
| "本周" | 本周一 → 今天 |
| "上周" | 上周一 → 上周日 |
| "上周五到本周四" | 计算具体日期 |
| "1/27 到 1/31" | 2025-01-27 → 2025-01-31 |
| "最近7天" | 今天往前推7天 → 今天 |

- **日期格式**：统一使用 M/D（如 1/6）或 YYYY-MM-DD
- **跨年处理**：如果起止日期跨年，需要正确处理年份
- **git --since/--until**：传入 YYYY-MM-DD 格式，until 日期加上 23:59:59 确保包含当天

## 多仓库支持

在 Step 0.2 中收集用户的项目路径列表，对每个仓库：

1. 验证路径有效性（`.git` 目录存在）
2. 提取项目名（目录名 或 package.json name）
3. 使用 `git -C {path}` 执行命令，无需 cd
4. 合并所有仓库数据后按项目分组展示

## 注意事项

1. **隐私保护**：不要在周报中暴露敏感的代码细节或内部系统信息
2. **语言风格**：使用简洁的书面语，避免口语化
3. **数据准确**：Git 记录是基础数据源，但需要用户确认和补充
4. **灵活调整**：用户可以随时要求修改格式、增删内容
5. **进度估算**：如果用户没提供进度，不要瞎编，标记为"进行中"
